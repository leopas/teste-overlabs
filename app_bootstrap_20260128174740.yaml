properties:
  environmentId: /subscriptions/06cd0a82-44bf-42fe-ab19-2851e9301697/resourceGroups/rg-overlabs-prod/providers/Microsoft.App/managedEnvironments/env-overlabs-prod-248
  configuration:
    ingress:
      external: true
      targetPort: 8000
      transport: http
    registries:
    - server: acrchoperia.azurecr.io
      username: acrchoperia
      passwordSecretRef: acr-password
    secrets:
    - name: acr-password
      value: LZgpBETBTvDKE91cl+XLJdVP4Lt9dgakHcFcBM8YXv+ACRA7dHk7
  template:
    containers:
    - name: api
      image: acrchoperia.azurecr.io/choperia-api:latest
      env:
      - name: QDRANT_URL
        value: "http://app-overlabs-qdrant-prod-248:6333"
      - name: REDIS_URL
        value: "redis://app-overlabs-redis-prod-248:6379/0"
      - name: DOCS_ROOT
        value: "/app/DOC-IA"
      - name: AUDIT_LOG_ENABLED
        value: "1"
      - name: ABUSE_RISK_THRESHOLD
        value: "0.80"
      - name: PROMPT_FIREWALL_RULES_PATH
        value: "config/prompt_firewall.regex"
      - name: MYSQL_DATABASE
        value: "teste-overlabs"
      - name: QDRANT_PORT
        value: "6333"
      - name: LOG_LEVEL
        value: "INFO"
      - name: AUDIT_LOG_INCLUDE_TEXT
        value: "1"
      - name: PROMPT_FIREWALL_ENABLED
        value: "1"
      - name: MYSQL_SSL_CA
        value: "./certs/DigiCertGlobalRootCA.crt.pem"
      - name: USE_OPENAI_EMBEDDINGS
        value: "1"
      - name: MYSQL_USER
        value: "tester-overlabs"
      - name: OTEL_ENABLED
        value: "0"
      - name: OPENAI_EMBEDDINGS_MODEL
        value: "text-embedding-3-small"
      - name: RATE_LIMIT_PER_MINUTE
        value: "60"
      - name: FIREWALL_LOG_SAMPLE_RATE
        value: "0.01"
      - name: PROMPT_FIREWALL_MAX_RULES
        value: "200"
      - name: MYSQL_HOST
        value: "cerve565db.mysql.database.azure.com"
      - name: AUDIT_LOG_RAW_MAX_CHARS
        value: "2000"
      - name: ABUSE_CLASSIFIER_ENABLED
        value: "1"
      - name: TRACE_SINK
        value: "mysql"
      - name: OPENAI_MODEL
        value: "gpt-4o-mini"
      - name: CACHE_TTL_SECONDS
        value: "600"
      - name: PIPELINE_LOG_INCLUDE_TEXT
        value: "0"
      - name: AUDIT_LOG_RAW_MODE
        value: "risk_only"
      - name: PIPELINE_LOG_ENABLED
        value: "0"
      - name: AUDIT_ENC_AAD_MODE
        value: "trace_id"
      - name: AUDIT_LOG_REDACT
        value: "1"
      - name: PROMPT_FIREWALL_RELOAD_CHECK_SECONDS
        value: "2"
      - name: DOCS_HOST_PATH
        value: "./DOC-IA"
      - name: MYSQL_PASSWORD
        value: @Microsoft.KeyVault(SecretUri=https://kv-overlabs-prod-248.vault.azure.net/secrets/mysql-password/)
      - name: OPENAI_API_KEY
        value: @Microsoft.KeyVault(SecretUri=https://kv-overlabs-prod-248.vault.azure.net/secrets/openai-api-key/)
      resources:
        cpu: 2.0
        memory: 4.0Gi
      volumeMounts:
      - volumeName: docs
        mountPath: /app/DOC-IA
    scale:
      minReplicas: 1
      maxReplicas: 5
    volumes:
    - name: docs
      storageType: AzureFile
      storageName: documents-storage